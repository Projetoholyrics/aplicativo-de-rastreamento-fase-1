<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localizador GPS + DDD</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo-dot"></div>
        <h1>Localizador GPS + DDD</h1>
      </div>
      <div class="note muted">Protótipo: GPS real + cidade por DDD</div>
    </header>

    <main class="main">
      <section class="left-panel">
        <div class="card">
          <h2>Controle</h2>
          <p class="muted">Clique em <strong>Localizar Agora</strong> ou digite o DDD e pressione Enter.</p>

          <div class="actions">
            <button id="btnLocate" class="btn primary">Localizar GPS</button>
          </div>

          <div class="card ddd-card">
            <h3>Rastrear por DDD</h3>
            <input type="text" id="inputDDD" placeholder="Digite DDD + número (ex: 11 912345678)" />
          </div>

          <div class="privacy">
            <strong>Aviso de privacidade:</strong>
            <p class="muted">GPS precisa de permissão do navegador. A cidade do DDD é uma aproximação (sem rastrear número real).</p>
          </div>
        </div>

        <div class="card info">
          <h3>Informações GPS</h3>
          <div id="infoBox" class="infoBox">
            <div class="infoRow"><strong>Status:</strong> <span id="statusText">Aguardando</span></div>
            <div class="infoRow"><strong>Latitude:</strong> <span id="latText">—</span></div>
            <div class="infoRow"><strong>Longitude:</strong> <span id="lonText">—</span></div>
            <div class="infoRow"><strong>Cidade:</strong> <span id="cityText">—</span></div>
            <div class="infoRow"><strong>Bairro:</strong> <span id="neighText">—</span></div>
            <div class="infoRow"><strong>Estado / País:</strong> <span id="stateText">—</span></div>
          </div>
          <div id="dddInfo" class="infoBox">
            <div class="infoRow"><strong>DDD:</strong> <span id="dddText">—</span></div>
            <div class="infoRow"><strong>Cidade estimada:</strong> <span id="dddCityText">—</span></div>
          </div>
        </div>
      </section>

      <section class="right-panel">
        <div class="card map-card">
          <div class="tracker-header">
            <h2 id="mapTitle">Mapa — Satélite</h2>
            <div id="mapNote" class="muted">Marcador azul = GPS | Marcador vermelho = DDD</div>
          </div>

          <div id="map" class="map"></div>
        </div>
      </section>
    </main>

    <footer class="footer muted">Protótipo seguro — teste localmente no navegador</footer>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  const btnLocate = document.getElementById('btnLocate');
  const inputDDD = document.getElementById('inputDDD');
  const statusText = document.getElementById('statusText');
  const latText = document.getElementById('latText');
  const lonText = document.getElementById('lonText');
  const cityText = document.getElementById('cityText');
  const neighText = document.getElementById('neighText');
  const stateText = document.getElementById('stateText');
  const dddText = document.getElementById('dddText');
  const dddCityText = document.getElementById('dddCityText');

  // Map init (center Brazil)
  const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-14.2, -51.9], 4);

  const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19
  }).addTo(map);

  // pulse markers
  const blueIcon = L.divIcon({ html:'<span class="pulse-marker blue"></span>', className:'pulse-div-icon', iconSize:[20,20], iconAnchor:[10,10] });
  const redIcon = L.divIcon({ html:'<span class="pulse-marker red"></span>', className:'pulse-div-icon', iconSize:[20,20], iconAnchor:[10,10] });

  let gpsMarker = null;
  let dddMarker = null;
  let pulseLine = null;

  async function reverseGeocode(lat, lon){
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`, { headers:{'Accept-Language':'pt-BR'} });
      const data = await res.json();
      const a = data.address || {};
      // Forçar bairro Lorival Parente
      return {
        city: a.city||a.town||a.village||a.county||'',
        neighbourhood: 'Lorival Parente', 
        state: a.state||a.region||'',
        country: a.country||''
      };
    } catch(e){
      console.warn('Reverse geocode falhou', e);
      return null;
    }
  }

  async function locateGPS(){
    statusText.textContent = 'Solicitando permissão...';
    if(!navigator.geolocation){ statusText.textContent = 'Navegador não suporta GPS'; return; }

    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      latText.textContent = lat.toFixed(6);
      lonText.textContent = lon.toFixed(6);
      statusText.textContent = 'GPS obtido, buscando endereço...';

      if(gpsMarker) map.removeLayer(gpsMarker);
      gpsMarker = L.marker([lat,lon], {icon:blueIcon}).addTo(map);
      map.setView([lat,lon], 15, { animate:true });

      const rg = await reverseGeocode(lat,lon);
      if(rg){
        cityText.textContent = rg.city||'—';
        neighText.textContent = rg.neighbourhood||'—';
        stateText.textContent = (rg.state ? rg.state+' — ' : '') + (rg.country||'');
        statusText.textContent = 'Endereço GPS encontrado';
      } else {
        cityText.textContent = neighText.textContent = stateText.textContent = '—';
        statusText.textContent = 'Falha no reverse geocode';
      }

      updateTriangulation();
    }, (err)=>{
      statusText.textContent = 'Permissão negada ou erro';
    }, { enableHighAccuracy:true, maximumAge:0, timeout:12000 });
  }

  // DDD mapping (aproximado)
  const DDD_MAP = {
    "11":"São Paulo","12":"São José dos Campos","13":"Santos","14":"Bauru","15":"Sorocaba",
    "16":"Ribeirão Preto","17":"São José do Rio Preto","18":"Presidente Prudente","19":"Campinas",
    "21":"Rio de Janeiro","22":"Campos dos Goytacazes","24":"Volta Redonda",
    "27":"Vitória","28":"Cachoeiro de Itapemirim",
    "31":"Belo Horizonte","32":"Juiz de Fora","33":"Governador Valadares","34":"Uberlândia","35":"Poços de Caldas",
    "37":"Divinópolis","38":"Montes Claros",
    "41":"Curitiba","42":"Ponta Grossa","43":"Londrina","44":"Maringá","45":"Foz do Iguaçu","46":"Francisco Beltrão",
    "47":"Joinville","48":"Florianópolis","49":"Chapecó",
    "51":"Porto Alegre","53":"Pelotas","54":"Caxias do Sul","55":"Santa Maria",
    "61":"Brasília","62":"Goiânia","64":"Rio Verde","63":"Palmas","65":"Cuiabá","66":"Rondonópolis","67":"Campo Grande",
    "68":"Rio Branco","69":"Porto Velho","71":"Salvador","73":"Ilhéus","74":"Juazeiro","75":"Feira de Santana","77":"Vitória da Conquista",
    "79":"Aracaju","81":"Recife","82":"Maceió","83":"João Pessoa","84":"Natal","85":"Fortaleza","86":"Teresina","87":"Petrolina",
    "88":"Sobral","89":"Picos","91":"Belém","92":"Manaus","93":"Santarém","94":"Marabá","95":"Boa Vista","96":"Macapá","97":"Coari",
    "98":"São Luís","99":"Imperatriz"
  };

  function locateDDD(){
    const val = inputDDD.value.trim();
    if(!val){ dddText.textContent='—'; dddCityText.textContent='—'; return; }
    const ddd = val.split(' ')[0];
    const city = DDD_MAP[ddd] || 'Cidade desconhecida';
    dddText.textContent = ddd;
    dddCityText.textContent = city;

    // marker: remove antigo
    if(dddMarker) map.removeLayer(dddMarker);

    // simulate city center
    const cityCoords = { "São Paulo":[-23.5505,-46.6333],"Rio de Janeiro":[-22.9068,-43.1729],
      "Belo Horizonte":[-19.9167,-43.9345],"Brasília":[-15.7939,-47.8828],"Curitiba":[-25.4284,-49.2733],
      "Porto Alegre":[-30.0346,-51.2177],"Salvador":[-12.9714,-38.5014],"Fortaleza":[-3.7319,-38.5267],
      "Recife":[-8.0476,-34.8770],"Belém":[-1.4550,-48.5024],"Manaus":[-3.1019,-60.0250],
      "São José dos Campos":[-23.1896,-45.8841]
    };
    const coord = cityCoords[city] || [-14.2,-51.9];
    dddMarker = L.marker(coord, {icon:redIcon}).addTo(map);

    updateTriangulation();
  }

  // Triangulação animada
  function drawTriangulation(){
    if(!gpsMarker || !dddMarker) return;
    const gpsLatLng = gpsMarker.getLatLng();
    const dddLatLng = dddMarker.getLatLng();

    if(pulseLine) map.removeLayer(pulseLine);

    pulseLine = L.polyline([gpsLatLng, dddLatLng], {
      color:'#06b6d4',
      weight:3,
      opacity:0.7,
      dashArray:'10,10',
      className:'pulse-line'
    }).addTo(map);

    let offset = 0;
    function animateLine(){
      if(!pulseLine) return;
      offset = (offset + 1) % 20;
      pulseLine.getElement().style.strokeDashoffset = offset;
      requestAnimationFrame(animateLine);
    }
    requestAnimationFrame(animateLine);
  }

  function updateTriangulation(){
    drawTriangulation();
  }

  btnLocate.addEventListener('click', locateGPS);
  inputDDD.addEventListener('keypress', (e)=>{
    if(e.key==='Enter') locateDDD();
  });
  </script>
</body>
</html>
